<!-- templates/select_categories.html -->

{% extends "base.html" %}

{% block title %}视频类型选择{% endblock %}

{% block content %}
    <h2 class="mb-4">请在下列15种视频类型中选择您最想要观看的3类视频。</h2>
    <p>
        通过拖动滑块对您喜爱的三类视频进行排序。<br>
        一旦您选择的视频类型数量达到3, 滑块将会自动锁定。若您想要改变您的选择, 请点击“重置”按钮重新选择。<br>
        数值越高, 该平台推荐某一类型视频的可能性越大。
    </p>
    <form method="POST" action="{{ url_for('submit_categories') }}">
        <div class="mb-3">
            <button type="button" class="btn btn-secondary mb-3" id="resetBtn">重置</button>
            <div class="list-group">
                {% for category in categories %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input me-1 category-checkbox" type="checkbox" name="categories" value="{{ category.id }}" id="category{{ category.id }}">
                            <label class="form-check-label" for="category{{ category.id }}">
                                {{ category.name }}
                            </label>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="1" max="10" value="5" class="slider form-range" id="slider{{ category.id }}" name="rating_{{ category.id }}" disabled>
                            <span id="value{{ category.id }}">5</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>提交</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.category-checkbox');
            const sliders = document.querySelectorAll('.slider');
            const values = document.querySelectorAll('span[id^="value"]');
            const resetBtn = document.getElementById('resetBtn');
            const submitBtn = document.getElementById('submitBtn');
            let selectedCount = 0;

            checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', function() {
                    const categoryId = this.value;
                    const slider = document.getElementById(`slider${categoryId}`);
                    const valueSpan = document.getElementById(`value${categoryId}`);

                    if (this.checked) {
                        selectedCount++;
                        slider.disabled = false;
                        submitBtn.disabled = selectedCount !== 3;
                        if (selectedCount === 3) {
                            checkboxes.forEach((cb) => {
                                if (!cb.checked) cb.disabled = true;
                            });
                        }
                    } else {
                        selectedCount--;
                        slider.disabled = true;
                        slider.value = 5;
                        valueSpan.textContent = '5';
                        submitBtn.disabled = selectedCount !== 3;
                        checkboxes.forEach(cb => cb.disabled = false);
                    }
                });

                const categoryId = checkbox.value;
                const slider = document.getElementById(`slider${categoryId}`);
                const valueSpan = document.getElementById(`value${categoryId}`);

                slider.addEventListener('input', function() {
                    valueSpan.textContent = this.value;
                });
            });

            resetBtn.addEventListener('click', function() {
                checkboxes.forEach((checkbox) => {
                    checkbox.checked = false;
                    checkbox.disabled = false;
                    const categoryId = checkbox.value;
                    const slider = document.getElementById(`slider${categoryId}`);
                    const valueSpan = document.getElementById(`value${categoryId}`);
                    slider.disabled = true;
                    slider.value = 5;
                    valueSpan.textContent = '5';
                });
                selectedCount = 0;
                submitBtn.disabled = true;
            });
        });
    </script>
{% endblock %}